<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Login | Baluch Martyrs Memorial</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #0066cc, #dc143c, #228b22);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            font-family: Arial, sans-serif;
        }
        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .debug-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-color, #2c5530);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 1rem;
        }
        .login-btn:hover {
            background: #1a3d20;
        }
        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }
        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            background: #2d3748;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 0.8rem;
        }
        .test-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>üêõ Debug Admin Login</h1>
            <p>Diagnostic version with detailed logging</p>
        </div>

        <div class="debug-section">
            <div class="debug-title">üîç System Check</div>
            <div id="systemCheck">Running diagnostics...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">üìã Debug Controls</div>
            <button class="test-btn" onclick="testModuleImport()">Test Module Import</button>
            <button class="test-btn" onclick="testSessionStorage()">Test Storage</button>
            <button class="test-btn" onclick="clearAllSessions()">Clear Sessions</button>
            <button class="test-btn" onclick="testCredentials()">Test Credentials</button>
        </div>

        <div id="errorMessage" class="error-message"></div>

        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required autocomplete="username" value="admin">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required autocomplete="current-password" value="baluch2024!">
            </div>
            
            <button type="submit" class="login-btn" id="loginBtn">
                üîê Debug Login
            </button>
        </form>

        <div class="debug-section">
            <div class="debug-title">üìä Live Debug Log</div>
            <div id="debugLog" class="debug-log">Starting debug session...\n</div>
        </div>

        <a href="index.html" style="color: #666; text-decoration: none; font-size: 0.9rem;">
            ‚Üê Back to Website
        </a>
    </div>

    <script>
        // Debug logging
        const debugLog = document.getElementById('debugLog');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugLog.textContent += logEntry;
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // Also log to browser console
            if (type === 'error') {
                originalConsoleError(message);
            } else if (type === 'warn') {
                originalConsoleWarn(message);
            } else {
                originalConsoleLog(message);
            }
        }

        // Override console methods to capture all logs
        console.log = (message, ...args) => {
            log(message + (args.length ? ' ' + args.join(' ') : ''), 'info');
        };
        console.error = (message, ...args) => {
            log(message + (args.length ? ' ' + args.join(' ') : ''), 'error');
        };
        console.warn = (message, ...args) => {
            log(message + (args.length ? ' ' + args.join(' ') : ''), 'warn');
        };

        // System diagnostics
        function runSystemCheck() {
            const systemCheck = document.getElementById('systemCheck');
            let report = '';
            
            report += `üåê User Agent: ${navigator.userAgent.substring(0, 50)}...\n`;
            report += `üìç URL: ${window.location.href}\n`;
            report += `üïí Time: ${new Date().toISOString()}\n`;
            report += `üì± Mobile: ${/Mobile|Android/i.test(navigator.userAgent)}\n`;
            report += `üåç Online: ${navigator.onLine}\n`;
            report += `üóÇÔ∏è Document Ready: ${document.readyState}\n`;
            report += `üîÑ Support Modules: ${typeof import !== 'undefined'}\n`;
            report += `üíæ localStorage: ${typeof Storage !== 'undefined'}\n`;
            
            systemCheck.innerHTML = '<pre>' + report + '</pre>';
            log('System check completed');
        }

        // Test functions
        window.testModuleImport = async function() {
            log('Testing module import...');
            try {
                const authModule = await import('./js/auth.js');
                log('‚úÖ auth.js imported successfully');
                log('Available exports: ' + Object.keys(authModule).join(', '));
                
                if (authModule.adminAuth) {
                    log('‚úÖ adminAuth object available');
                    log('adminAuth methods: ' + Object.getOwnPropertyNames(Object.getPrototypeOf(authModule.adminAuth)).join(', '));
                    
                    // Test basic methods
                    try {
                        const isAuth = authModule.adminAuth.isAuthenticated();
                        log('isAuthenticated() result: ' + isAuth);
                        
                        const currentAdmin = authModule.adminAuth.getCurrentAdmin();
                        log('getCurrentAdmin() result: ' + (currentAdmin ? currentAdmin.username : 'null'));
                        
                        const timeRemaining = authModule.adminAuth.getSessionTimeRemaining();
                        log('getSessionTimeRemaining() result: ' + timeRemaining + ' minutes');
                        
                    } catch (methodError) {
                        log('‚ùå Error testing auth methods: ' + methodError.message, 'error');
                    }
                    
                } else {
                    log('‚ùå adminAuth not found in module');
                }
                
                window.testAdminAuth = authModule.adminAuth;
                
            } catch (error) {
                log('‚ùå Module import failed: ' + error.message, 'error');
                log('Error details: ' + error.stack, 'error');
            }
        };

        window.testSessionStorage = function() {
            log('Testing session storage...');
            try {
                const testKey = 'test_session_' + Date.now();
                const testData = { test: true, time: Date.now() };
                
                localStorage.setItem(testKey, JSON.stringify(testData));
                sessionStorage.setItem(testKey, JSON.stringify(testData));
                
                const localResult = localStorage.getItem(testKey);
                const sessionResult = sessionStorage.getItem(testKey);
                
                if (localResult && sessionResult) {
                    log('‚úÖ Session storage working correctly');
                    log('Local storage test: ' + localResult);
                    log('Session storage test: ' + sessionResult);
                } else {
                    log('‚ùå Session storage failed');
                }
                
                // Cleanup
                localStorage.removeItem(testKey);
                sessionStorage.removeItem(testKey);
                
                // Also check for existing sessions
                const sessionKey = 'baluch_admin_session';
                const existingLocal = localStorage.getItem(sessionKey);
                const existingSession = sessionStorage.getItem(sessionKey);
                
                log('Existing local session: ' + (existingLocal ? 'YES' : 'NO'));
                log('Existing session storage: ' + (existingSession ? 'YES' : 'NO'));
                
                if (existingLocal) {
                    try {
                        const sessionData = JSON.parse(existingLocal);
                        log('Session username: ' + sessionData.username);
                        log('Session expires: ' + new Date(sessionData.expires).toLocaleString());
                        log('Session expired: ' + (sessionData.expires < Date.now() ? 'YES' : 'NO'));
                    } catch (e) {
                        log('‚ùå Invalid session data format', 'error');
                    }
                }
                
            } catch (error) {
                log('‚ùå Session storage error: ' + error.message, 'error');
            }
        };

        window.clearAllSessions = function() {
            log('Clearing all admin sessions...');
            const sessionKey = 'baluch_admin_session';
            localStorage.removeItem(sessionKey);
            sessionStorage.removeItem(sessionKey);
            log('‚úÖ All sessions cleared');
            
            // Run storage test to confirm
            setTimeout(() => {
                testSessionStorage();
            }, 500);
        };

        window.testCredentials = function() {
            log('Testing credential validation...');
            const credentials = {
                'admin': 'baluch2024!',
                'moderator': 'memorial@admin'
            };
            
            const testUsername = document.getElementById('username').value.trim();
            const testPassword = document.getElementById('password').value;
            
            log(`Testing: username="${testUsername}", password="${testPassword}"`);
            
            if (credentials[testUsername] && credentials[testUsername] === testPassword) {
                log('‚úÖ Credentials are valid', 'info');
            } else {
                log('‚ùå Credentials are invalid', 'error');
                log('Available usernames: ' + Object.keys(credentials).join(', '));
                log('Expected password for ' + testUsername + ': ' + (credentials[testUsername] || 'N/A'));
            }
        };

        // Error display
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            log('Error shown to user: ' + message, 'error');
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 8000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.background = '#d4edda';
            errorDiv.style.color = '#155724';
            errorDiv.style.display = 'block';
            log('Success shown to user: ' + message, 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Debug login page loaded');
            runSystemCheck();
            
            // Auto-test module import
            setTimeout(() => {
                testModuleImport();
            }, 1000);
            
            // Auto-test storage
            setTimeout(() => {
                testSessionStorage();
            }, 1500);
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            log('üîê Login form submitted');
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            log(`Login attempt: username="${username}"`);
            
            if (!username || !password) {
                showError('Please enter both username and password');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Testing Login...';

            try {
                // Test credentials first
                const ADMIN_CREDENTIALS = {
                    'admin': 'baluch2024!',
                    'moderator': 'memorial@admin'
                };

                log('Validating credentials...');
                if (ADMIN_CREDENTIALS[username] && ADMIN_CREDENTIALS[username] === password) {
                    log('‚úÖ Credentials validated');
                    
                    // Test if we can import and use auth module
                    log('Importing auth module...');
                    const authModule = await import('./js/auth.js');
                    log('‚úÖ Auth module imported');
                    
                    if (authModule.adminAuth) {
                        log('Creating session with adminAuth...');
                        const sessionData = authModule.adminAuth.createSession(username);
                        log('Session creation result: ' + JSON.stringify(sessionData));
                        
                        if (sessionData) {
                            log('‚úÖ Session created successfully');
                            
                            // Verify session
                            if (authModule.adminAuth.isAuthenticated()) {
                                log('‚úÖ Authentication verified');
                                showSuccess('Login successful! Redirecting to admin panel...');
                                
                                setTimeout(() => {
                                    log('Redirecting to admin.html');
                                    window.location.href = 'admin.html';
                                }, 2000);
                                return;
                            } else {
                                log('‚ùå Authentication verification failed', 'error');
                                showError('Session verification failed');
                            }
                        } else {
                            log('‚ùå Session creation failed', 'error');
                            showError('Failed to create session');
                        }
                    } else {
                        log('‚ùå adminAuth not available in module', 'error');
                        showError('Authentication module not available');
                    }
                } else {
                    log('‚ùå Invalid credentials', 'error');
                    showError('Invalid username or password');
                }
                
            } catch (error) {
                log('‚ùå Login error: ' + error.message, 'error');
                log('Error stack: ' + error.stack, 'error');
                showError('Login failed: ' + error.message);
            }

            loginBtn.disabled = false;
            loginBtn.textContent = 'üîê Debug Login';
        });

        log('Debug login page initialization complete');
    </script>
</body>
</html>
