<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gallery of Baluch Martyrs - Browse our memorial database">
    <title>Martyrs Gallery - Baluch Martyrs Memorial</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/chatbot.css">
    
    <!-- Professional Static Asset Refresh System -->
    <script src="js/asset-refresh.js"></script>
</head>
<body>
    <!-- Header Section -->
    <header class="site-header">
        <nav class="navbar">
            <div class="container">
                <div class="nav-brand">
                    <h1>Baluch Martyrs Memorial</h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="add-martyr.html">Add Martyr</a></li>
                    <li><a href="gallery.html" class="active">Gallery</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><div id="google_translate_element"></div></li>
                </ul>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <section class="gallery-section">
            <div class="container">
                <div class="page-header">
                    <h2>Martyrs Gallery</h2>
                    <p>Browse through our memorial database to honor and remember our heroes</p>
                </div>

                <!-- Search/Filter Bar -->
                <div class="filter-bar">
                    <div class="search-controls">
                        <div class="search-input-group">
                            <input type="text" id="searchMartyrs" placeholder="Search by name, location, or organization...">
                            <button type="button" id="clearSearch" title="Clear search">√ó</button>
                        </div>
                        <button type="button" id="toggleAdvancedSearch" class="btn-small">Advanced Search</button>
                    </div>
                    
                    <!-- Advanced Search Panel -->
                    <div id="advancedSearchPanel" class="advanced-search-panel" style="display: none;">
                        <div class="search-row">
                            <div class="search-field">
                                <label for="searchByName">Name:</label>
                                <input type="text" id="searchByName" placeholder="Search by martyr name...">
                            </div>
                            <div class="search-field">
                                <label for="searchByLocation">Location:</label>
                                <input type="text" id="searchByLocation" placeholder="Birth or martyrdom place...">
                            </div>
                        </div>
                        <div class="search-row">
                            <div class="search-field">
                                <label for="searchByOrganization">Organization:</label>
                                <input type="text" id="searchByOrganization" placeholder="Organization or group...">
                            </div>
                            <div class="search-field">
                                <label for="searchByYear">Year:</label>
                                <input type="number" id="searchByYear" placeholder="Martyrdom year" min="1900" max="2030">
                            </div>
                        </div>
                        <div class="search-actions">
                            <button type="button" id="applyAdvancedSearch" class="btn-small">Apply Filters</button>
                            <button type="button" id="clearAdvancedSearch" class="btn-small btn-outline">Clear All</button>
                        </div>
                    </div>
                    
                    <!-- Search Results Info -->
                    <div id="searchResultsInfo" class="search-results-info" style="display: none;">
                        <span id="resultsCount">0</span> <span id="resultsLabel">martyrs found</span>
                        <button type="button" id="clearAllFilters" class="clear-filters-btn">Clear filters</button>
                    </div>
                </div>

                <!-- Gallery Grid -->
                <div class="gallery-grid" id="galleryGrid">
                    <!-- Professional loading state will be shown by JavaScript -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Baluch Martyrs Memorial</h3>
                    <p>Preserving the memory of our heroes who gave their lives for freedom.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="add-martyr.html">Add Martyr</a></li>
                        <li><a href="gallery.html">Gallery</a></li>
                        <li><a href="about.html">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>Email: info@baluchmemorial.org</p>
                    <p>Phone: +92-XXX-XXXXXXX</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Baluch Martyrs Memorial. All rights reserved.</p>
                <p>Data managed by <strong>Baloch Martyrs Committee</strong> ‚Ä¢ Powered by <strong>Benjamin Baluch</strong></p>
            </div>
        </div>
    </footer>

    <!-- Load gallery.js first to ensure functions are available -->
    <script src="js/main.js"></script>
    <script src="js/mobile-menu.js"></script>
    <script src="js/chatbot.js"></script>
    <script src="js/gallery.js"></script>
    
    <script type="module">
        // PROFESSIONAL Firebase Connection Manager
        console.log('üî• Initializing professional Firebase connection...');
        
        class FirebaseConnectionManager {
            constructor() {
                this.firebaseDB = null;
                this.isConnected = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                this.connectionTimeout = 15000; // 15 seconds
            }
            
            async initialize() {
                try {
                    console.log(`üîß Firebase connection attempt ${this.retryCount + 1}/${this.maxRetries}`);
                    
                    // Import Firebase with timeout
                    const importPromise = import('./js/firebase-config.js');
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Firebase import timeout')), this.connectionTimeout)
                    );
                    
                    const { firebaseDB } = await Promise.race([importPromise, timeoutPromise]);
                    this.firebaseDB = firebaseDB;
                    
                    // Test connection immediately
                    const testResult = await this.testConnection();
                    if (!testResult.success) {
                        throw new Error(testResult.error);
                    }
                    
                    // Make available globally
                    window.firebaseDB = firebaseDB;
                    window.firebaseReady = true;
                    this.isConnected = true;
                    
                    console.log('‚úÖ Firebase connection established successfully');
                    return true;
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Firebase connection attempt ${this.retryCount + 1} failed:`, error.message);
                    
                    this.retryCount++;
                    if (this.retryCount < this.maxRetries) {
                        console.log(`üîÑ Retrying in ${2 * this.retryCount} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, 2000 * this.retryCount));
                        return this.initialize();
                    }
                    
                    console.error('‚ùå Firebase connection failed after all retries');
                    return false;
                }
            }
            
            async testConnection() {
                if (!this.firebaseDB) return { success: false, error: 'Firebase not initialized' };
                
                try {
                    const testPromise = this.firebaseDB.testConnection();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection test timeout')), 10000)
                    );
                    
                    return await Promise.race([testPromise, timeoutPromise]);
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            async loadMartyrsData() {
                if (!this.isConnected || !this.firebaseDB) {
                    throw new Error('Firebase not connected');
                }
                
                try {
                    console.log('üìã Fetching martyrs from Firebase...');
                    const dataPromise = this.firebaseDB.getApprovedMartyrs();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Data fetch timeout')), 20000)
                    );
                    
                    const result = await Promise.race([dataPromise, timeoutPromise]);
                    
                    if (result && result.success && result.data) {
                        console.log(`‚úÖ Successfully loaded ${result.data.length} martyrs from Firebase`);
                        
                        // Cache to localStorage
                        try {
                            localStorage.setItem('martyrsData', JSON.stringify(result.data));
                            localStorage.setItem('martyrsData_timestamp', Date.now().toString());
                            console.log('üíæ Data cached to localStorage');
                        } catch (e) {
                            console.warn('LocalStorage caching failed:', e);
                        }
                        
                        return result.data;
                    } else {
                        throw new Error(result?.error || 'No data received from Firebase');
                    }
                } catch (error) {
                    console.error('‚ùå Firebase data fetch failed:', error.message);
                    throw error;
                }
            }
            
            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('martyrsData');
                    const timestamp = localStorage.getItem('martyrsData_timestamp');
                    
                    if (!saved) {
                        throw new Error('No localStorage data available');
                    }
                    
                    const data = JSON.parse(saved);
                    const approved = data.filter(m => !m.status || m.status === 'approved');
                    
                    if (approved.length === 0) {
                        throw new Error('No approved martyrs in localStorage');
                    }
                    
                    // Check data age
                    const age = timestamp ? Date.now() - parseInt(timestamp) : 0;
                    const ageHours = Math.floor(age / (1000 * 60 * 60));
                    
                    console.log(`üíæ Loaded ${approved.length} martyrs from localStorage (${ageHours}h old)`);
                    return { data: approved, age: ageHours };
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è LocalStorage fallback failed:', error.message);
                    throw error;
                }
            }
        }
        
        // Initialize connection manager and load data
        const connectionManager = new FirebaseConnectionManager();
        
        async function initializeGalleryData() {
            try {
                // Try Firebase connection
                const firebaseConnected = await connectionManager.initialize();
                
                let martyrsData = null;
                let source = 'unknown';
                
                if (firebaseConnected) {
                    try {
                        martyrsData = await connectionManager.loadMartyrsData();
                        source = 'Firebase';
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Firebase data loading failed, trying localStorage...', error.message);
                    }
                }
                
                // Fallback to localStorage if Firebase failed
                if (!martyrsData) {
                    try {
                        const localResult = connectionManager.loadFromLocalStorage();
                        martyrsData = localResult.data;
                        source = `localStorage (${localResult.age}h old)`;
                        
                        // Show offline warning for old data
                        if (localResult.age > 24) {
                            console.warn(`‚ö†Ô∏è Using old cached data (${localResult.age}h old)`);
                        }
                    } catch (error) {
                        console.error('‚ùå All data loading methods failed:', error.message);
                        martyrsData = [];
                        source = 'empty';
                    }
                }
                
                // Store globally and trigger event
                window.martyrsDataFromFirebase = martyrsData;
                window.firebaseConnectionStatus = {
                    connected: firebaseConnected,
                    source: source,
                    dataCount: martyrsData.length,
                    timestamp: new Date().toISOString()
                };
                
                console.log(`üé® Gallery data ready: ${martyrsData.length} martyrs from ${source}`);
                
                // Trigger data ready event
                window.dispatchEvent(new CustomEvent('martyrsDataReady', { 
                    detail: { 
                        data: martyrsData, 
                        source: source,
                        connected: firebaseConnected
                    } 
                }));
                
            } catch (error) {
                console.error('‚ùå Gallery initialization failed completely:', error);
                
                // Dispatch empty data event
                window.dispatchEvent(new CustomEvent('martyrsDataReady', { 
                    detail: { 
                        data: [], 
                        source: 'failed',
                        error: error.message
                    } 
                }));
            }
        }
        
        // Start initialization
        initializeGalleryData();
        
        // Expose connection manager for debugging
        window.firebaseConnectionManager = connectionManager;
        window.retryFirebaseConnection = () => {
            connectionManager.retryCount = 0;
            return initializeGalleryData();
        };
        
    </script>

    <!-- Google Translate Scripts -->
    <script type="text/javascript">
    function googleTranslateElementInit() {
        new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
        hideBannerAndFixLayout();
    }
    function hideBannerAndFixLayout() {
        ['.goog-te-banner-frame', 'iframe.goog-te-banner-frame', '.skiptranslate', '#goog-gt-tt', '.goog-te-balloon-frame'].forEach(selector => {
            document.querySelectorAll(selector).forEach(el => { if (el) { el.style.display = 'none'; el.remove(); } });
        });
        document.body.style.top = '0'; document.body.style.marginTop = '0'; document.body.style.paddingTop = '0';
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => { mutation.addedNodes.forEach(node => {
                if (node.nodeType === 1 && node.classList && (node.classList.contains('goog-te-banner-frame') || node.classList.contains('skiptranslate'))) node.remove();
            }); });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    setInterval(hideBannerAndFixLayout, 1000);
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <!-- Initialize Professional Asset Refresh System -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof StaticAssetRefresh !== 'undefined') {
            try {
                window.initAutoRefresh({
                    enableLogging: false,
                    refreshInterval: 30 * 60 * 1000,
                    cookiePrefix: 'bmm_cache_',
                    autoRefresh: true
                });
                
                window.forceRefreshAssets = async function() {
                    const results = await window.refreshStaticAssets({ enableLogging: true });
                    console.log('‚úÖ Gallery assets refreshed:', results);
                    return results;
                };
            } catch (error) {
                console.warn('‚ö†Ô∏è Asset refresh failed:', error);
            }
        }
    });
    </script>
</body>
</html>
